<?php
namespace Home\Controller;
use Think\Controller;
 header("content-type:text/html;charset=utf8");
 class RoleController extends Controller
 {
   public $salt;
   public $surl;
   public $partner_name;
   public $secret_key;
   public function _initialize()
   {
	 $this->salt=C(SALT);
	 $this->surl=C(SURL);
	 $this->partner_name=C(PNAME);
	 $this->secret_key=C(SECRET_KEY);
   }
 	/*
	*/
	public function index(){
		$list=M('organization')->select();
		$this->list=$list;
		$this->show();
	}
	//添加会员
	public function add()
	{
		$username=I('post.username');
		$pwd=md5(sha1(I('post.pwd').$this->salt));
		$mobile=I('post.mobile',0);
		$data['username']=$username;
		$data['password']=$pwd;
		$data['mobile']=$mobile;
		$data['status']=I('post.status');//1为启用0为禁用
		$data['idno']=I('post.idno',0);
		$data['reg_time']=time();
		$data['reg_ip']=ip2long($_SERVER['REMOTE_ADDR']);
		$data['pid']=I('post.pid');
		$data['authority']=I('post.authority');
		$um=M('ucenter_member');
		$hasthis=$um->getFieldByUsername($username,'id');
		//echo M()->_sql();
		if(!$hasthis)
		{
			$added=$um->add($data);
			//操作日志表
			if($added)
			{
			$op=array();
			$op['opname']=session('username');
			$op['optime']=time();
			$op['opdata']=serialize($data);
			$op['opip']=$data['reg_ip'];
			$op['optip']=$op['opname']."添加了一个角色id为".$added;
			$op['optbname']='ucenter_member';
			$op['opthatid']=$added;
			M('dts')->add($op);
			$this->success('成员已经添加成功');
			}
		}else{
			$this->error('嘿嘿，此账户已经存在');
		}

	}

		//显示标的抵押物信息jbox块2015-11-02 lj
	public function impawn()
	{
		$id=I('get.id',0);
		$list=M('house as h')->field('h.category,h.carbrand,h.cartype,h.carestimate,h.carbuytime,h.address,h.iscity,h.pledge,oh.housetype,h.estimateprice,h.area,h.price,h.residence')
		     ->join('onethink_housetype as oh on h.housetype=oh.id','left')
		     ->where('h.id='.$id)->find();
		   if($list['iscity']==1)
		   {
		   	$list['iscity']='否';
		   }else{
		   	$list['iscity']='是';
		   }
		   if($list['pledge']==1)
		   {
		   	$list['pledge']="清房";
		   }else if($list['pledge']==2)
		   {
		   	$list['pledge']="一抵";
		   }else{
		   	$list['pledge']='按揭';
		   }

		if($list['category']=='car')
		{
		$html="<table border='1px'><tr><td>车品牌</td><td>车类型</td><td>车估价(元)</td><td>车购买时间</td></tr>";
		$html.="<tr><td>".$list['carbrand']."</td><td>".$list['cartype']."</td><td>".$list['carestimate']."</td><td>".date('Ymd',$list['carbuytime'])."</td></tr></table>";
		}else if($list['category']=='fang'){
		$html="<table border='1px'><tr><td>房屋地址</td><td>是否主城区</td><td>抵押情况</td><td>房屋面积（平米）</td><td>房屋市场价(元)</td><td>房屋评估价(元)</td><td>房屋类型</td><td>房屋户口</td></tr>";
		$html.="<tr><td>".$list['address']."</td><td>".$list['iscity']."</td><td>".$list['pledge']."</td>
				<td>".$list['area']."</td><td>".$list['price']."</td><td>".$list['estimateprice']."</td><td>".$list['housetype']."<td>".$list['residence']."</td></tr></table>";
		}else{
			$html='暂无数据';
		}
		echo $html;
	}

	
	
	public function remember()
	{	

		$this->show();
	}//eof rem



	public function messagesend()
	{
		$time=strtotime(date('Y-m-d 00:00:00'));//今天开始的时候
		$threedayslater=strtotime("+3 days",$time);//三天后的这个时候
		$daythree=date("Y-m-d",$threedayslater);
		$res=M('repayplan')
		->alias('as oe')
		->field('oe.id,oe.hid,UNIX_TIMESTAMP(oe.shouldtime) as shouldtime,oe.shouldrepay,h.tel,h.cstname,oum.username,oum.mobile')
		->join('onethink_house as h on oe.hid=h.id')
		->join('onethink_ucenter_member as oum on h.respid=oum.id')
		->where("UNIX_TIMESTAMP(oe.shouldtime)=".$threedayslater)
		->select();
		 // dump($res);
		foreach ($res as $key => $value) 
		{	
		   $mobile=$value['mobile'];//手机号码
		   // echo $mobile;
		   $content="亲爱的财来网同事:".$value['username']."，你有个客户".$value['cstname']."(".$value['tel'].")"."，在财来网的借款将在3天后".$daythree.'号有一笔还款,金额为'.$value['shouldrepay'].'请及时催收。'. $mobile;
		   dump($this->sendsms($mobile,$content));
		   echo "如果出现1代表已经成功"."</br>";
		}

	}



	/**
	 * 发送短信提醒
	 */
	public function sendsms($mobile,$content)
	{
        $surl=$this->surl;;

       	$data['secret_key']=$this->secret_key;

  		$data['pname'] = $this->partner_name;

  		$data['mobile']=$mobile;

  		$data['content']= $content;

  		//模拟post 请求
	    $ch = curl_init() ;  
	  	$fields = $data;
		curl_setopt($ch, CURLOPT_URL,$surl);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);//控制返回结果不让自动输出
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);//对ssl 证书错误 不验证
		curl_setopt($ch, CURLOPT_POST,count($fields)) ; // 启用时会发送一个常规的POST请求，类型为：application/x-www-form-urlencoded，就像表单提交的一样。  
		curl_setopt($ch, CURLOPT_POSTFIELDS,$fields); // 在HTTP中的“POST”操作。如果要传送一个文件，需要一个@开头的文件名  		

		$result = curl_exec($ch);//其值为 成功为1 不成功为 no auth
	
		return $result;
		// return $result;
		// if($result==1)
		// {
		// 	$json['status']='ok';
		// 	//return $json['status'];
		// 	// echo ok;
		// 	//exit(json_encode($json));
		// }else{
		// 	$json['status']='no';
		// 	// echo no;
		// 	//return $json['status'];
		// 	//exit(json_encode($json));
		// }

	}

	/**
	 * 我的任务--展示页
	 */

	public function mytask()
	{
		$username=session('username');
		//->where('status=1')
		$uid=M('ucenter_member')->getFieldByUsername($username,'id');
		$list=M('house as h')->field('h.*,os.id as oid,os.status')->join('onethink_status as os on h.status=os.id')->where('h.respid='.$uid.' and h.status=4')->select();
		$this->uid=$uid;
		$this->list=$list;
		$this->display();
	}

	/**
	 * 任务完成确认--
	 */
	public function taskconfirm()
	{
		$uid=I('get.uid',0);//负责人id
		$taskid=I('get.taskid',0);//任务id
		$house=M('house');
		$data['status']=5;//5为已完成
		$data['finishtime']=time();
		$res=$house->where('id='.$taskid.' and respid='.$uid)->save($data);
		// echo M()->_sql();
		// die;
		if($res!==false)
		{
			$op=array();
			$op['opname']=session('username');
			$op['optime']=time();
			$op['opdata']=serialize($data);
			$op['opip']=ip2long($_SERVER['REMOTE_ADDR']);
			$op['optip']=$op['opname']."完成了一个项目id为：".$taskid;
			$op['optbname']='house';
			$op['opthatid']=$taskid;
			M('dts')->add($op);
			$this->success('已经确认');
		}else{
			$this->error('确认失败');
		}

	}

	/**
	 * 已完成的任务
	 */
	public function donetask()
	{
		$house=M('house as h');
		$data['status']=5;//5为已完成
		$data['finishtime']=time();
		$username=session('username');
		$res=$house->join('onethink_ucenter_member as oum on h.respid=oum.id','left')
		     ->join('onethink_status as os on h.status=os.id')
		     ->field('h.*,oum.status as oums,os.status')->where('oum.username='."'".$username."'".' and h.status=5')->select();
		// echo M()->_Sql();
		// echo M()->getDbError();
		$this->list=$res;
		$this->display();

	}
	/**
	 * 2015-11-16
	 * 风控复核
	 * 银行 银行卡  姓名  是否有过桥 过桥人 过桥卡号
	 */
	public function riskcontrol()
	{
		$cstname=I('post.cstname',0);
		$pid=session('pid');//资金来源
		 // echo $pid;
		if($pid!=1)
		{
		 $condition['h.capitalsource']=$pid;
		}
 		if($cstname)
		{
			$condition['h.cstname']=$cstname;
			$list=M('house')->alias('as h')->where($condition)->select();
			$this->list=$list;
			$this->show();
			return;
		}
		$condition['h.status']=5;
		$count      = M('house')->alias('as h')->where($condition)->count();// 查询满足要求的总记录数
		$Page       = new \Think\Page($count,10);// 实例化分页类 传入总记录数和每页显示的记录数(25)
		$show       = $Page->show();// 分页显示输出
		// 进行分页数据查询 注意limit方法的参数要使用Page类的属性
		// $list = M('house')->order('add_time desc')->limit($Page->firstRow.','.$Page->listRows)->select();
		$list=M('house')
		      ->alias('as h')
		      ->field('h.*,os.status')
		      ->join('onethink_status as os on h.status=os.id')
		      ->where($condition)
		      ->order('add_time desc')
		      ->limit($Page->firstRow.','.$Page->listRows)
		      ->select();
		       // echo M()->getlastSql();
		// dump($list);
		$this->pid=$pid;
		$this->list=$list;
		$this->page=$show;
		$this->display();
	}

	/**
	 * 2015-11-16 riskdetail 风控复核详细
	 * @id 
	 */
	public function riskdetail()
	{
		$id=I('get.id',0);
		$list=M("house as h")->find($id);
		$this->list=$list;
		$this->display();
	}
	/**
	 * 2015-11-17 riskadd 风控详细 @author yee
	 */
	public function riskadd()
	{
		$data['hid']=I('post.id',0);
		// $data['bank']=I('post.bank',0);
		// $data['bankcard']=I('post.bankcard',0);
		$data['bridge']=I('post.bridge',0);
		$data['bridgename']=I('post.bridgename',0);
		$data['bridgecardno']=I('post.bridgecardno',0);
		$data['checktip']=I('post.checktip',0);
		$data['checkname']=I('post.checkname',0);
		$data['ispass']=I('post.ispass',0);
		$res=M('checksec')->add($data);
		if($res)
		{
		//更新状态
		 $h['status']='9';//9为已复审
 		 M('house')->where('id='.$data['hid'])->save($h);

		$op=array();
		$op['opname']=session('username');
		$op['optime']=time();
		$op['opdata']=serialize($data);
		$op['opip']=ip2long($_SERVER['REMOTE_ADDR']);
		$op['optip']=$op['opname']."复审一个项目id为：".$data['hid'];
		$op['optbname']='house';
		$op['opthatid']=$data['hid'];
		M('dts')->add($op);

		 $url=U('Role/riskcontrol');
		 $message='复核成功';
		 $this->success($message,$url);
		}else{
		 //$url=U('Role/riskcontrol');
		 $message='复核失败';
		 $this->error($message);
		}
	}


	public function manageadd()
	{
		$data['organization']=I('post.organization');
		$res=M('organization')->add($data);
		if($res)
		{
		 $this->success('添加成功');
		}else{
		 $this->error('添加失败');
		}
	}

	public function riskasync()
	{
		$idarr=I('post.id');
		$data['checkname']=session('username');
		$data['checktip']="同意";
		$data['ispass']=1;//1为通过
		// $idarr=json_decode($idarr,1);
		foreach (@$idarr as $key => $value) {
			$data['hid']=$value;
			M('checksec')->add($data);
			$h['status']='9';//9为已复审
 		    M('house')->where('id='.$data['hid'])->save($h);
		}
		 
		$op=array();
		$op['opname']=session('username');
		$op['optime']=time();
		$op['opdata']=serialize($data);
		$op['opip']=ip2long($_SERVER['REMOTE_ADDR']);
		$op['optip']=$data['checkname']."复审一个项目id为：".$data['hid'];
		$op['optbname']='house';
		$op['opthatid']=$data['hid'];
		M('dts')->add($op);

		echo 1;
	}
	//过桥人贷款
	public function manage()
	{
		$list=M('organization')->select();
		$this->list=$list;
		$this->display();
	}

	public function bridgeadd()
	{
		$bridge=M('member_info');
		$data=$bridge->create();
		$res=$bridge->add($data);
		if($res)
		{
		$op=array();
		$op['opname']=session('username');
		$op['optime']=time();
		$op['opdata']=serialize($data);
		$op['opip']=ip2long($_SERVER['REMOTE_ADDR']);
		$op['optip']=$op['opname']."添加了一个名叫：".$data['nickname']."的过桥放款人";
		$op['optbname']='house';
		$op['opthatid']=$res;
		M('dts')->add($op);
		$this->success("添加成功");
		}else{
			$this->error("添加失败");
		}
	}

	/**
	 * 业务员催收日历
	 */
	public function calendar()
	{
		$username=session('username');
		$id=M('ucenter_member')->getFieldByUsername($username,'id');
		$month=date("m");
		$year=date('Y');

		// echo $id;
		$res=M('repayplan')
		->alias('as oe')
		->field('oe.id,oe.hid,oe.shouldtime as shouldtime,oe.shouldrepay ,h.tel,h.cstname,oum.username,oum.mobile')
		->join('onethink_house as h on oe.hid=h.id')
		->join('onethink_ucenter_member as oum on h.respid=oum.id')
		->where("h.respid=".$id.' and Month(oe.shouldtime)='.$month." and Year(oe.shouldtime)=".$year)
		->group('h.cstname,shouldtime')
		->order('UNIX_TIMESTAMP(oe.shouldtime)')
		->select();
		// echo M()->_sql();
		// dump($res);
		// die;
		foreach (@$res as $key => $value) {

			$value['tel']=$value['tel']?$value['tel']:"xxxxxxxxxxx";//为了保持电话数据长度一致性
			 $calendar[]=$value['shouldtime']."&姓名：".$value['cstname'].".&电话：".$value['tel'].".&金额：".$value['shouldrepay']."元;";
		}
		$res=json_encode($calendar);
 		// dump($res);
		$this->res=$res;
		$this->display();
	}


 }//eof class role